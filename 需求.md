# 需求规格说明书：创世纪引擎 V40.0 (最终修订版)

| **文档版本** | **修订日期** | **修订人** | **修订说明** |
| :--- | :--- | :--- | :--- |
| 1.0 | 2025-09-02 | Gemini AI | 初始版本，基于 V40.0 代码库创建 |
| 1.1 | 2025-09-02 | Gemini AI | 补充了AI助手交互、API适配层、UI微交互、扑克牌映射逻辑等实现细节。 |
| 1.2 | 2025-09-02 | Gemini AI | 补充了JSON模式、核心状态管理、关键用户交互流程闭环及数据净化等隐性逻辑。 |
| 1.3 | 2025-09-02 | Gemini AI | **最终版**。**修复了刷新页面导致登录状态丢失的BUG描述，明确了会话持久化逻辑。** |
| 2.0 | 2025-09-04 | Gemini AI | **新增【实现文件】章节，将需求与代码文件进行完整映射。** |

## 1. 引言 (Introduction)

### 1.1. 项目概述 (Project Overview)

“创世纪引擎”是一个面向专业网络小说作者、编剧及内容创作者的高度集成化、AI驱动的智能叙事构建系统。该系统旨在将一个模糊的初始“灵感”通过一套结构化、模块化的工作流，逐步深化、拓展并最终生成一篇具备商业潜质、结构完整、风格鲜明的小说初稿。其核心是“灵感驱动，AI赋能”，通过模拟专业编辑与创作者的协作流程，为用户提供从世界观构建到正文撰写的一站式解决方案。

### 1.2. 目标用户 (Target Audience)

*   **专业网络小说作者：** 寻求高效生产力工具，用于快速验证灵感、构建大纲和生成初稿。
*   **新手及业余作者：** 缺乏系统性创作方法论，需要一个结构化的引导来完成一部作品。
*   **编剧与游戏策划：** 需要快速构建世界观、人物小传和情节框架的创意工作者。

### 1.3. 核心理念与工作流 (Core Philosophy & Workflow)

本项目遵循一个严谨的“叙事漏斗”模型，将抽象的创意逐级具象化。核心工作流如下：

1.  **灵感孵化 (Inspiration)：** 用户输入核心创意，AI进行解构与深度拓展，形成包含三大核心弧光（人物、情节、情绪）的“故事种子”。
2.  **世界观构建 (Worldview)：** AI为“故事种子”匹配最佳叙事蓝本，并根据用户选择的模式（长/短篇）进行系统性设定填充。
3.  **要素生成 (Element Generation)：** 基于已确定的世界观，并行生成三大核心叙事要素：
    *   **人物卡组 (Characters)：** 塑造与人物弧光匹配的核心角色阵容。
    *   **故事链 (Story Chain)：** 细化情节弧光为关键节点序列。
    *   **情绪链 (Emotion Chain)：** 将情绪弧光设计为可执行的读者体验节奏。
4.  **蓝图整合 (Blueprint)：** AI扮演总编，将上述三大要素进行“三弧合一”的融合，制定详细的融合策略与伏笔规划，最终生成可执行的章节大纲。
5.  **执笔成文 (Scribing)：** AI扮演指定风格的“作者”（如番茄大神、文学大师），依据最终大纲，自动撰写完整的小说正文。
6.  **后期制作 (Post-Production)：** AI扮演顶级编辑，对成文稿件进行通篇润色，并根据目标发布平台（如番茄小说）的规则进行一键格式化与导出。

## 2. 总体设计 (Overall Design)

### 2.1. 技术栈 (Technology Stack)

*   **前端框架：** 无。采用原生 HTML5, CSS3, JavaScript (ES6+)。
*   **核心库：**
    *   **`Sortable.js`:** 用于实现人物卡组的拖拽排序功能。
    *   `Font Awesome`: 提供丰富的图标。
    *   `Google Fonts`: 提供赛博朋克(`Orbitron`)与奇幻(`Cinzel`)两种风格的艺术字体。
*   **数据持久化：** 浏览器 `localStorage`。

### 2.2. 架构概述 (Architectural Overview)

本应用为纯客户端单页应用 (Single-Page Application, SPA)。
*   **模块化设计：** 功能按标签页 (Tab) 划分，逻辑高度解耦，每个模块负责工作流中的一个特定阶段。
*   **状态管理：** 通过一个全局的JavaScript对象 `creationState` 管理当前项目的实时创作数据。通过 `projectLibrary` 和 `characterDeck` 管理用户的永久资产。
*   **数据持久化：** 所有用户数据（项目库、角色卡组、API设置）均存储在 `localStorage` 中，并与用户名进行绑定，实现用户数据隔离。

### 2.3. 视觉主题 (Visual Themes)

系统内置两套视觉主题，用户可随时切换，所有UI元素需能动态适应。

*   **赛博朋克 (Cyberpunk Theme - `theme-cyberpunk`) - 默认**
    *   **主色调：** 霓虹青 (`#00f5d4`)
    *   **辅助色：** 电光紫 (`#9b5de5`), 品红 (`#f15bb5`)
    *   **背景：** 深邃黑 (`#0d1117`)，带有网格背景图案
    *   **字体：** 标题使用 `Orbitron`，正文使用 `Noto Sans SC`
    *   **核心感觉：** 科技感、未来感、冷峻、高效。

*   **西方奇幻 (Fantasy Theme - `theme-fantasy`)**
    *   **主色调：** 华丽金 (`#e6a75a`)
    *   **辅助色：** 贵族红 (`#8a0707`), 深木色 (`#4a2c0f`)
    *   **背景：** 羊皮纸/深棕 (`#f5eeda`/`#2e261e`)，带有皮革纹理
    *   **字体：** 标题使用 `Cinzel`，正文使用 `Noto Sans SC`
    *   **核心感觉：** 史诗感、复古、庄重、沉浸。

## 3. 功能需求 (Functional Requirements)

### 3.1. 系统级功能

#### 3.1.1. 用户认证系统
*   **UI:** 顶部 Header 区域的“登录”、“注册”、“登出”按钮及欢迎信息。
*   **功能:**
    *   **注册:** 弹出提示框，要求输入用户名和密码。用户信息存储于 `localStorage` 的 `genesis_engine_users` 对象中。需验证用户名是否已存在。
    *   **登录:** 弹出提示框，验证用户名和密码。成功后，在 `localStorage` 中设置 `genesis_engine_currentUser`，并解锁主应用界面。
    *   **登出:** 清除当前用户状态，锁定主应用界面。
    *   **状态保持:** 页面加载时自动检查登录状态，并更新UI。**刷新页面不能导致用户登出。**
*   **【实现文件】:**
    *   **核心逻辑:** `js/core/04_用户认证.js`
    *   **状态管理:** `js/core/01_状态管理.js` (currentUser 变量)
    *   **UI结构:** `index.html` (Header部分)
    *   **初始化调用:** `js/main.js`

#### 3.1.2. 项目管理系统
*   **UI:** “项目管理”按钮，项目管理模态框 (`project-manager-modal`)。
*   **功能:**
    *   **项目列表:** 模态框内展示当前用户的所有项目，按“最后修改时间”降序排列。
    *   **保存项目:**
        *   **保存当前:** 若当前工作区已关联一个项目ID，则更新该项目内容。
        *   **另存为新项目:** 将当前工作区内容保存为一个新项目，要求用户输入项目名称。
    *   **加载项目:** 从项目列表点击“加载”，将该项目的数据完整填充回 `creationState` 并刷新所有模块UI。
    *   **删除项目:** 提供二次确认，从 `projectLibrary` 中移除项目。
    *   **重命名项目:** 弹出提示框，修改项目标题。
    *   **导出项目:** 支持导出为 `.txt` 或 `.doc` 格式，包含灵感核心和世界观设定的完整文本。
*   **【实现文件】:**
    *   **核心逻辑:** `js/modules/project_manager.js`
    *   **状态管理:** `js/core/01_状态管理.js` (projectLibrary, currentProjectId, creationState)
    *   **UI结构:** `index.html` (`#project-manager-modal`)
    *   **初始化调用:** `js/main.js`

#### 3.1.3. API 配置模块
*   **UI:** “API设置”按钮，API设置模态框 (`api-settings-modal`)。
*   **功能:**
    *   **服务商选择:** 下拉菜单支持 Google Gemini, OpenAI, DeepSeek, 硅基流动, Ollama(本地), 自定义。
    *   **动态表单:** UI根据所选服务商动态显示/隐藏 API Key、Base URL、模型名称等输入框。
    *   **本地保存:** 所有API设置保存在 `localStorage`，不与项目绑定。
    *   **API适配层:** `callApi` 函数需作为适配器，根据用户选择的服务商，动态构建正确的请求体（`contents` for Gemini, `messages` for OpenAI-compatible）并解析不同结构的响应体。
    *   **JSON模式控制:** `callApi` 函数需接收 `isJsonMode` 布尔参数。当为 `true` 时，必须向API请求结构化的JSON输出；为 `false` 时，则请求非结构化的纯文本。
*   **【实现文件】:**
    *   **核心逻辑:** `js/core/03_API接口.js`
    *   **UI结构:** `index.html` (`#api-settings-modal`)
    *   **初始化调用:** `js/main.js`

#### 3.1.4. AI 助手 (Assistant Widget)
*   **UI:** 界面右下角的浮动按钮及弹出式窗口。
*   **目的:** 作为核心工作流中“AI编辑审核”环节的**专属可视化反馈窗口**。
*   **功能:**
    *   **被动触发:** 在用户执行需要AI审核的操作后，此窗口自动接收并显示审核状态和反馈信息。
    *   **状态同步:** 状态指示器 (`#assistant-status`) 必须与当前正在审核模块的 `validationState` 严格同步，实时反映“审核中”、“审核通过”、“需要修改”等状态。
    *   **历史记录:** 以对话形式记录每次审核的交互历史。
*   **【实现文件】:**
    *   **核心逻辑:** `js/core/02_通用工具.js` (`addAssistantMessage` 函数)
    *   **UI结构:** `index.html` (`#assistant-widget`)
    *   **初始化调用:** `js/main.js`

#### 3.1.5. 资料库面板
*   **UI:** “资料库”切换按钮，以及 `角色系统`、`角色原型`、`情节系统`、`情绪系统`、`叙事圣典` 等多个资料库标签页。
*   **功能:**
    *   **专注模式切换:** “资料库”按钮可一键隐藏/显示所有资料库导航标签，提供专注的创作界面。
    *   **内容展示:** 以只读的富文本样式（表格、卡片等）展示系统内置的创作知识库。
*   **【实现文件】:**
    *   **核心逻辑:** `js/main.js` (`toggleDatabasePanels` 函数)
    *   **各面板渲染逻辑:**
        *   `js/database/叙事圣典面板.js`
        *   `js/database/角色系统面板.js`
        *   `js/database/角色原型面板.js`
        *   `js/database/情节系统面板.js`
        *   `js/database/情绪系统面板.js`
    *   **UI结构:** `index.html` (Header中的按钮和导航栏部分)
    *   **数据源:**
        *   `js/data/叙事圣典数据.js`
        *   `js/data/角色系统数据.js`
        *   `js/data/角色原型数据.js`
        *   `js/data/情节系统数据.js`
        *   `js/data/情绪系统数据.js`

### 3.2. 核心创作工作流模块

#### 3.2.1. 灵感系统 (Inspiration)
*   **UI:** 左右布局。左侧为灵感输入区，右侧为AI生成与审核区。
*   **功能:**
    *   **灵感输入:** 用户在文本域输入初始想法或点击“热门灵感模板”。
    *   **模板交互:** 点击任一“热门灵感模板”，其简介将自动填充至灵感输入框，并**立即触发“AI解析”流程**。
    *   **AI解析:** AI分析输入文本，自动从预设标签库中匹配最合适的“主题”、“角色”、“情节”，并更新UI。
    *   **AI深度拓展:** AI基于匹配的标签组合，生成包含“爆款标题”、“简介核心”以及“人物/情节/情绪三大弧光”的完整故事种子。
    *   **智能标题生成:** 提供一个独立按钮，可以调用AI根据特定的“爆款标题方法论”生成多个备选标题。
    *   **AI编辑审核:** 系统自动将生成的故事种子提交给AI进行二次审核，AI将扮演“资深编辑”角色，判断其商业潜力并给出修改建议，结果反馈至 **AI 助手**。
    *   **迭代重构:** 若审核不通过，用户可一键“采纳建议并重构”，AI将带着修改建议重新生成故事种子。
    *   **确认进入下一步:** 审核通过（或用户强制接受）后，用户点击“确认并选择模式”，锁定灵感，进入世界观构建阶段。
*   **【实现文件】:**
    *   **核心逻辑:** `js/modules/01_灵感系统.js`
    *   **UI结构:** `index.html` (`#inspiration-panel`, `#title-selection-modal`)
    *   **数据源:** `js/data/灵感与世界观数据.js` (`comboData`, `TITLE_GENERATION_METHODOLOGY`), `js/data/热门灵感模板数据.js`

#### 3.2.2. 世界观设定 (Worldview)
*   **UI:** 顶部显示已锁定的灵感核心，主体为世界观设定展示区。
*   **功能:**
    *   **模式选择:** 用户需从“短篇模式”和“长篇模式”中二选一。
    *   **AI蓝本匹配:** AI分析灵感，从内置的 `WORLDVIEW_BLUEPRINTS` 库中匹配最合适的风格蓝本。
    *   **AI一键拓展:**
        *   **短篇模式:** AI将三大弧光分别进行深化和扩写。
        *   **长篇模式:** AI将围绕12个核心维度（如背景冲突、力量体系、关键势力等）进行全面、详细的设定填充。
    *   **AI编辑审核 & 迭代:** 与灵感系统逻辑相同，对生成的世界观进行审核与重构。
    *   **确认世界观:** 用户确认最终的世界观设定，数据存入 `creationState`。**此操作是解锁后续所有生成器模块的前提**。
*   **【实现文件】:**
    *   **核心逻辑:** `js/modules/02_世界观设定.js`
    *   **UI结构:** `index.html` (`#worldview-panel`)
    *   **数据源:** `js/data/灵感与世界观数据.js` (`WORLDVIEW_BLUEPRINTS`)

#### 3.2.3. 人物卡生成器 (Character Generator)
*   **UI:** 分为“智能阵容生成”和“永久角色卡组”两大区域。
*   **功能:**
    *   **数据源:** 自动读取已确认的“人物弧光”作为生成依据。
    *   **AI生成阵容:** AI根据人物弧光，一次性生成一个包含主角、盟友、反派在内的4-5人核心阵容。
    *   **永久卡组:**
        *   生成或手动创建的人物都将存入一个永久的、用户专属的 `characterDeck` 中。该数组长度固定为54，以**映射一副完整的扑克牌**。
        *   UI以扑克牌形式展示，必须支持**通过 `Sortable.js` 实现拖拽排序**。
        *   提供增、删、改、查功能，所有修改通过模态框完成。
    *   **蓝图选择机制:** 用户通过卡片上的复选框进行多选。点击“加入蓝图”按钮时，系统将 `selectedCharacterIds` 数组中所有ID对应的角色对象，存入 `creationState.blueprintCharacters`。
*   **【实现文件】:**
    *   **核心逻辑:** `js/modules/03_人物卡生成器.js`
    *   **UI结构:** `index.html` (`#char-generator-panel`, `#character-editor-modal`)
    *   **依赖库:** `Sortable.js` (在 `index.html` 中引入)

#### 3.2.4. 故事卡 & 情绪卡生成器 (Story & Emotion Generators)
*   **UI/功能:** 这两个模块逻辑高度一致。
    *   **数据源:** 分别读取已确认的“情节弧光”和“情绪弧光”。
    *   **AI构造链条:** AI将抽象的弧光，转化为一个由多个具体节点组成的、具有清晰逻辑的“故事链”或“情绪链”，并以Markdown格式输出。
    *   **AI编辑审核 & 迭代:** 逻辑同上。
    *   **加入蓝图:** 用户确认后，将生成的完整Markdown文本存入 `creationState`。
*   **【实现文件】:**
    *   **故事卡逻辑:** `js/modules/04_故事卡生成器.js`
    *   **情绪卡逻辑:** `js/modules/05_情绪卡生成器.js`
    *   **UI结构:** `index.html` (`#story-generator-panel`, `#emotion-generator-panel`)

#### 3.2.5. 蓝图骨架 (Blueprint)
*   **UI:** 左右布局，左侧为“叙事融合策略”，右侧为“故事大纲”。
*   **功能:**
    *   **前置条件:** 必须在前面模块中成功“加入蓝图”了人物、故事和情绪三个要素，此模块的核心按钮才会被激活。
    *   **生成融合策略:** AI扮演“总编”，整合所有输入材料（人物卡、故事链、情绪链），制定一份“三弧合一”的详细执行计划，包括伏笔设计、渲染手法等。
    *   **生成故事大纲:** AI严格依据“融合策略”和用户设定的章节数，生成一份详细的、分章节的完整故事大纲。
    *   **数据存储:** 融合策略和大纲的**最终HTML内容**将被存入 `creationState`，以保留其富文本格式供后续模块使用。
    *   **锁定大纲:** 用户确认大纲，将其锁定为最终稿，**此操作是解锁“圣典执笔者”的前提**。
*   **【实现文件】:**
    *   **核心逻辑:** `js/modules/06_蓝图骨架.js`
    *   **UI结构:** `index.html` (`#blueprint-panel`)

#### 3.2.6. 圣典执笔者 (Scribe)
*   **UI:** 左右布局。左侧为可折叠的参考资料区（叙事圣典、开篇蓝本等），右侧为正文创作工作台。
*   **功能:**
    *   **数据源:** 自动加载已锁定的“最终大纲”。
    *   **数据净化:** 在将大纲内容发送给AI前，必须调用 `sanitizeForTemplate` 函数，剥离所有HTML标签，确保AI指令的纯净性。
    *   **AI作者人格选择:** 用户可以选择不同的AI写作风格（如：番茄长篇风格、汪曾祺风格、通用风格）。
    *   **AI撰写正文:** AI将严格遵循大纲和选定的人格，自动撰写指定总字数的小说正文。
    *   **数据存储:** 生成的完整稿件存入 `creationState.finalProse`，为进入后期制作做准备。
*   **【实现文件】:**
    *   **核心逻辑:** `js/modules/07_圣典执笔者.js`
    *   **UI结构:** `index.html` (`#scribe-panel`)
    *   **数据净化工具:** `js/core/02_通用工具.js` (`sanitizeForTemplate` 函数)
    *   **数据源:** `js/data/灵感与世界观数据.js` (`OPENING_BLUEPRINTS`)

#### 3.2.7. AI创作词典 (Post-Production / Dictionary)
*   **UI:** 上下布局，上部为“AI通篇润色”，下部为“最终格式化与导出”。
*   **功能:**
    *   **数据源:** 自动加载已生成的正文稿件。
    *   **AI通篇润色:** AI扮演“顶级编辑”，对全文进行文笔、节奏、情绪张力的深度优化。
    *   **一键格式化:** 这是一个**两步AI流程**。首先，AI扮演“平台编辑”，根据内置的复杂规则为文章智能匹配标签；然后，系统根据AI返回的标签和文章内容，自动组装成标准的发布格式。
    *   **多格式导出:** 支持将最终格式化的文本导出为 `.txt`, `.md`, `.doc` 文件。
*   **【实现文件】:**
    *   **核心逻辑:** `js/modules/08_AI创作词典.js`
    *   **UI结构:** `index.html` (`#dictionary-panel`)
    *   **导出工具:** `js/core/02_通用工具.js` (`downloadFile` 函数)

## 4. 数据模型与持久化 (Data Model & Persistence)

### 4.1. 核心数据对象

*   **`creationState` (Object):** 存储当前活动项目的临时数据。
    *   `inspirationConcept`: 灵感系统产出的故事种子对象。
    *   `worldview`: 世界观设定对象。
    *   `blueprintCharacters`: 从永久卡组中为本项目选中的角色数组。
    *   `storyChain`: 故事链Markdown文本。
    *   `emotionChain`: 情绪链Markdown文本。
    *   `weavingPlan`: 融合策略HTML文本。
    *   `finalOutline`: 最终大纲HTML文本。
    *   `finalProse`: 最终正文纯文本。

*   **`projectLibrary` (Array):** 存储用户所有项目的数组，每个项目是一个包含完整 `creationState` 的对象。

*   **`characterDeck` (Array):** 存储用户永久角色卡的数组，固定长度为54。

*   **`validationState` (Object):** 存储各模块的当前审核状态（`pending`, `validating`, `approved`, `rejected`），用于控制UI和工作流。

*   **`lastValidationResult` (Object):** 存储最近一次AI审核返回的完整JSON对象，包含反馈和修改建议，用于“采纳建议并重构”功能。

### 4.2. 本地存储策略

*   所有数据均使用 `localStorage` 存储。
*   键名采用 `[用户名]_[数据名]_[版本号]` 的格式，例如: `gemini_projectLibrary_v1`。
*   这种设计确保了多用户在同一浏览器登录时数据不会互相干扰。

### **4.3. 会话状态持久化 (Session State Persistence)**

*   **登录持久化:** 用户的登录状态 (`currentUser`) 存储在 `localStorage` 中，必须在关闭浏览器、刷新页面后依然保持。
*   **资产持久化:** 用户的永久资产（`projectLibrary`, `characterDeck`）同样存储于 `localStorage`，确保数据不会丢失。
*   **工作区状态处理:**
    *   **场景1：刷新页面 (`checkLoginStatus`)**: 当已登录用户刷新页面时，系统应静默恢复其登录UI状态和已加载的永久资产，但**不能**清空其当前正在进行中的、未保存的工作 (`creationState`)。
    *   **场景2：手动登录 (`updateUIAfterLogin`)**: 当用户通过点击“登录”按钮成功登录时，系统应为其提供一个全新的工作环境，即必须调用 `resetCreationState` 函数来**清空**上一个用户可能留下的工作区数据。

## 5. 非功能性需求 (Non-Functional Requirements)

*   **性能 (Performance):** 所有AI调用必须是异步的，并在等待期间向用户提供明确的加载状态（如按钮禁用、加载动画），避免UI卡死。
*   **可用性 (Usability):**
    *   工作流引导清晰，用户在完成一步后能明确知道下一步该做什么。
    *   提供实时的通知反馈（成功、失败、信息）。
    *   所有AI生成的内容都应是“可编辑”的，赋予用户最终决定权。
    *   **微交互:** 所有可交互元素必须提供明确的视觉反馈（hover, active, disabled状态），以提升用户体验。
*   **兼容性 (Compatibility):** 应用应在最新版本的 Chrome、Firefox、Edge 浏览器上正常运行。
*   **安全性 (Security):** API密钥等敏感信息仅存储于客户端本地，不应传输到任何第三方服务器。